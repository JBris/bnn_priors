\documentclass{article}
\usepackage{adria}
\usepackage[english]{babel}
\usepackage[style=authoryear,bibencoding=utf8,backend=biber,natbib=true,uniquename=false,uniquelist=false,maxbibnames=99]{biblatex}
\addbibresource{../references.bib}
\author{Adrià Garriga-Alonso}
\date{\today}
\title{Langevin MCMC and its M-H acceptance probability}
\hypersetup{
 pdfauthor={Adrià Garriga Alonso},
 pdftitle={Langevin MCMC and its M-H acceptance probability},
 pdfkeywords={},
 pdfsubject={},
 pdfcreator={}, 
 pdflang={English}}

\newcommand{\gradat}[1]{{\nabla_\vtheta U(\vtheta\ssup{#1})}}
\newcommand{\transition}[2]{{\bra{\vtheta\ssup{#1}, \vq\ssup{#1}} \to \bra{\vtheta\ssup{#2}, \vq\ssup{#2}}}}

\begin{document}
\maketitle
\abstract{MCMC via Langevin dynamics, in its usual form, has an acceptance
  probability of 0. In this document is an alternative discretisation of its
  stochastic differential equation (SDE) that is time-reversible, and thus has a
  non-zero acceptance probability}

\section{Introduction}
\label{sec:orgb532d68}
The acceptance probability of an MCMC sampler that follows the Langevin
stochastic differential equations (SDE) is always 1. However, to be able to
simulate the SDE, we discretise the time steps, and in so introduce error.
This error can be exactly corrected \cite{sarkka_solin_2019} by adding a
Metropolis-Hastings (M-H) step, that applies rejection sampling for the new
state of the SDE. Additional error is introduced by the approximate
floating-point arithmetic, but we will disregard it.

In Langevin MCMC, we have some parameters \(\theta\) to be inferred (also named
\emph{position variables}), and their corresponding \emph{momentum variables} \(m\). The
generalised Metropolis-Hastings acceptance probability \cite{bussi-parrinello},
which negates the final momentum, is as follows. If a transition goes from 
\((\theta_0, m_0) \to (\theta_*, m_*)\), its acceptance probability is
\begin{equation}
  \text{Pr}_\text{accept}(\theta_*, m_*) = \text{min}\left(1,
      \frac{\pi(\theta_*) T(\theta_0, -m_0 | \theta_*, -m_*)}
          {\pi(\theta_0) T(\theta_*, m_* | \theta_0, m_0)} \right)
\end{equation}
for transition probability density \(T\) and target distribution density \(\pi\).
If a sample \((\theta_*, m_*)\) is rejected, we have to set the next state of
the chain to \((\theta_0, -m_0)\) (and not \((\theta_0, m_0)\) like ordinary
Metropolis-Hastings).

It is important to note that the transition probability distribution \(T\), and
thus the acceptance probability, very much depend on the scheme we use to
discretise time in the SDE. That is, the integrator.

\section{Symplectic Euler integrator}
\label{sec:org786af88}
The Symplectic Euler integrator used in \cite{wenzel20posterior} is not time
reversible in the limit of zero friction. This implies that the probability of
transitioning \((\theta_*, -m_*) \to (\theta_0, m_0)\) is always zero, strictly
speaking. This is because the value of \(\theta_*\) is determined entirely by
the previous parameters, \(\theta_0\), and its \textbf{contemporaneous} momentum
\(m_*\). The forward transition for the parameters is
\begin{equation}
  \theta_* = \theta_0 + h M^{-1} m_*.
\end{equation}

Now, consider what the backward transition would be. The momentum \(-m_*\)
evolves to \(-m_0\), and the parameters \(\theta_*\) evolve to \(\theta_0\). The
transition, now applied backward, is
\begin{equation}
  \theta_0 = \theta_* + h M^{-1} (-m_0),
\end{equation}
which cannot be true if \(m_0 \ne m_*\).

\section{Related work}

\citet{mannella2004} published a stochastic integrator for Langevin dynamics
that reduces to the normal Störmer-Verlet integrator on the limit of $\gamma \to
0$. However, it is in position form, that is, it first updates the position,
then the velocity, then the position again. Thus, it is not easily adapted to an
MCMC algorithm. \citet{groenbech-complete-verlet} describes a form of Mannella's
integrator which corresponds to velocity Verlet. However, neither of these
schemes is suitable for MCMC in Langevin dynamics: they only use one Gaussian
random variable per time step, and Langevin dynamics is not measure-preserving.
This implies that the backwards transition also has probability 0
\citep{bussi-parrinello}.

\citet{bussi-parrinello} also wrote an integration scheme that reduces to the
velocity Störmer-Verlet integrator. Their explicit intention is to correct the
error introduced by discretising the time-step, using the Metropolis-Hastings
correction. They note that, since the dynamics of Langevin dynamics are not
measure preserving, unlike those of Hamiltonian flow, the acceptance probability
with discrete time steps cannot be simply the reduction in log-joint
probability. Instead, the forward and backward probability of transition have to
be explicitly calculated.
Unfortunately, it can be shown \citep{lm-aboba} that their integration scheme
overestimates the temperature of the velocity in a simple 1D harmonic
oscillator.

\citet{scc-time-rescaling} solve this problem by scaling the gradient time step
down by a factor of $0.95 \le b \le 1$, which we define in the next
section. Their proposed OVRVO integrator (so named by the order in which various
operators are applied) is the approach we employ in this document.

\section{OVRVO integration in one dimension}
\label{sec:org7376eca}
We use the OVRVO integrator by \cite{scc-time-rescaling}. It is symmetric
under time reversal and employs two independent Gaussian RVs per time step, so
its probability of acceptance is never zero and can be evaluated.

At the same time, if the exact momenta are not needed, the Gaussian RVs can be
fused for an amortised computational cost of 1 random draw per time step. This
changes the long-term temperature statistics, but in an easily correctable
manner.

The Langevin dynamics differential equations are
\begin{align}
  dr(t) &= v(t) \\
  dv(t) &= -\gamma v(t) + m^{-1}f(r(t)) + m^{-\frac{1}{2}}\sqrt{2\gamma T}dW
\end{align}
where \(dW\) is a Wiener process.

For discrete time step \(h\), the corresponding OVRVO updates are
\begin{align}
a &\eqdef e^{-\gamma h} \\
b &\eqdef \sqrt{\frac{2}{\gamma h} \tanh \bra{\frac{\gamma h}{2}}} \\
  v\ssup{n+\frac{1}{2}} &\eqdef \sqrt{a} v\ssup{n} + \frac{bh}{2}m^{-1}f\ssup{n} + m^{-\frac{1}{2}}\sqrt{(1-a)T} \epsilon^{n+\frac{1}{2}} \\
r\ssup{n+\frac{1}{2}} &\eqdef r\ssup{n} + \frac{b h}{2} v\ssup{n+\frac{1}{2}} \\
  r\ssup{n+1} &\eqdef r\ssup{n+\frac{1}{2}} + \frac{b h}{2} v\ssup{n+\frac{1}{2}} \\
  v\ssup{n+1} &\eqdef \sqrt{a} v\ssup{n+\frac{1}{2}} + \frac{bh\sqrt{a}}{2}m^{-1}f\ssup{n+1} + m^{-\frac{1}{2}}\sqrt{(1-a)T} \epsilon^{n+1} \\
\intertext{We may also combine the two updates to \(v\) to give:}
v\ssup{n+\frac{1}{2}} &= a v\ssup{n-\frac{1}{2}} + \frac{bh(1 + a)}{2}m^{-1}f\ssup{n} + m^{-\frac{1}{2}}\sqrt{(1 - a^2)T} \epsilon^{n+\frac{1}{2}}
\intertext{And define an auxiliary quantity $u$:}
  u\ssup{n} &\eqdef v\ssup{n+\frac{1}{2}} - \frac{bh}{2}m^{-1}f\ssup{n} \\
  &= \sqrt{a}v\ssup{n} + m^{-\frac{1}{2}}\sqrt{(1-a)T} \epsilon^{n+\frac{1}{2}}
\end{align}

\subsection{Empirical temperature estimation}

Langevin dynamics allows for estimation of the temperature using the position
and velocity variables.
\begin{equation}
  T = \E\sqb{r(t)f(t)} = \E\sqb{m v(t)^2}
\end{equation}
for any $T$. We know that the velocity in particular is Gaussian-distributed \citep{bussi-parrinello,wenzel20posterior}
\begin{equation}
v(t) \sim \Normal{0, \frac{T}{m}}
\end{equation}

In the OVRVO integrator, the value of $r$ is more accurate at half
time steps, and the value of $v$ is more accurate at full time steps. For this
reason, we defined the quantity $u\ssup{n}$. Its distribution is
\begin{equation}
  u\ssup{n} \sim \Normal{0, a\frac{T}{m} + \frac{(1-a)T}{m}} = \Normal{0, \frac{T}{m}}.
\end{equation}
which means we can also check the temperature by empirically averaging $u\ssup{n}$.

\section{Multiple dimensions}
We introduce an unnormalised posterior density  $\pi(\vtheta)$ that we want to
sample from. This induces a potential $U(\vtheta) = -\log \pi(\vtheta)$.
The new, vector-valued, variables are
\begin{align*}
\vtheta(t) &\eqdef r(t) & \vq(t) &\eqdef \vM^{\frac{1}{2}} v(t) \\
\vM &\eqdef m &   \nabla_\vtheta U(\vtheta(t)) &\eqdef -f(t) \\
\end{align*}

At state $(\vtheta, \vq)$, the energy of the system is
\begin{equation}
  H(\vtheta, \vq) \eqdef U(\vtheta) + \frac{1}{2}\vq^\tp\vq,
  \label{eq:energy}
\end{equation}
and the canonical distribution of the dynamical system, for temperature $T$, is $p(\vtheta, \vq)
\propto \exp(-\frac{1}{T}H(\vtheta, \vq))$.

The Langevin differential equations are now
\begin{align}
  d\vtheta &= \vM^{-\frac{1}{2}} \vq dt \\
  d\vq &= - \vM^{-\frac{1}{2}}\nabla_\vtheta U(\vtheta)dt -\gamma \vq dt  + \sqrt{2\gamma T} d\vW.
\end{align}
We also reparameterize the time step $h$ and friction $\gamma$ by introducing
the momentum decay $\beta$ and the learning rate $\ell$. As listed by
\citet{wenzel20posterior}, $h = \sqrt{\ell / n}$ and $\gamma = (1 - \beta)\sqrt{n / \ell}$.

The reparameterised OVRVO scheme is
\begin{align}
a &\eqdef e^{\beta - 1} \\
b &\eqdef \sqrt{\frac{2}{1 - \beta} \tanh \bra{\frac{1- \beta}{2}}} \\
\vq\ssup{n+\frac{1}{2}} &\eqdef \sqrt{a} \vq\ssup{n} - \frac{bh}{2}\vM^{-\frac{1}{2}}\gradat{n} + \sqrt{(1-a)T} \vepsilon\ssup{n+\frac{1}{2}} \\
  \vtheta\ssup{n+1} &\eqdef \vtheta\ssup{n} + b h \vM^{-\frac{1}{2}}\vq\ssup{n+\frac{1}{2}} \\
\vq\ssup{n+1} &\eqdef \sqrt{a} \vq\ssup{n+\frac{1}{2}} - \frac{bh\sqrt{a}}{2}\vM^{-\frac{1}{2}}\gradat{n+1} + \sqrt{(1-a)T} \vepsilon\ssup{n+1} \\
\intertext{For computational convenience, we will use the parameters only at whole time steps, even though the integrator is slightly more accurate at half time steps in simple cases \citep{scc-time-rescaling}. We also redefine $u\ssup{n}$}
  \tilde{\vq}\ssup{n+1} &\eqdef \sqrt{a} \vq\ssup{n+\frac{1}{2}} + \sqrt{(1-a)T} \vepsilon\ssup{n+\frac{3}{2}}
\label{eq:ovrvo-updates}
\end{align}

For a $d$-dimensional parameter and momentum, the configurational and kinetic temperatures are
\begin{align}
  \hat{T}_c\ssup{n} &= \frac{1}{d}\angbra{\vtheta\ssup{n}, \gradat{n}} & \hat{T}_k\ssup{n} &= \frac{1}{d} \angbra{\tilde{\vq}\ssup{n}, \tilde{\vq}\ssup{n}}.
\end{align}
\subsection{Metropolis-Hastings acceptance probability}
Writing $x\ssup{n} = \bra{\vtheta\ssup{n}, \vq\ssup{n}}$, we associate with each
point $x\ssup{n}$ an importance weight $w\ssup{n}$ \citep{bussi-parrinello}. The
ratio of weights can be used in a Metropolis-Hastings acceptance probability
$x\ssup{n} \to x\ssup{n+1}$, as
\begin{equation}
\Pr\bra{\text{accept } x\ssup{n+1} \mvbar x\ssup{n}} = \min\bra{1, \frac{w\ssup{n+1}}{w\ssup{n}}}.
\end{equation}

We may express $w\ssup{n}$ in terms of an effective energy
$\tilde{H}\ssup{n} = -T \log w\ssup{n}$, which starts as $\tilde{H}\ssup{0} =
H(\vtheta\ssup{0}, \vq\ssup{0})$ and evolves as 
\begin{equation}
 \Delta\tilde{H} = \tilde{H}\ssup{n+1} - \tilde{H}\ssup{n} =
-T\log \frac{M(x\ssup{n} \vbar x\ssup{n+1})}
{M(x\ssup{n+1} \vbar x\ssup{n})}
+ H\bra{x\ssup{n+1}}  - H\bra{x\ssup{n}}.
\end{equation}

This effective energy should fluctuate during the simulation, but not exhibit a
systematic drift. If the momentum is resampled, it should be reset.

Solving for $\vepsilon\ssup{n+\frac{1}{2}}, \vepsilon\ssup{n}$ in
equation~\ref{eq:ovrvo-updates}, changing the variables in the probability density and
calculating the ratio, we get \citep{bussi-parrinello}:
\begin{align*}
  -T\log \frac{M(x\ssup{n} \vbar x\ssup{n+1})}
  {M(x\ssup{n+1} \vbar x\ssup{n})}
  &=
    -\frac{1}{2}\angbra{\gradat{n} + \gradat{n+1}, \vtheta\ssup{n+1} - \vtheta\ssup{n}} \\
  &+ \frac{h^2b^2}{8}\bra{\angbra{\gradat{n+1}, \vM^{-1}\gradat{n+1}} - \angbra{\gradat{n}, \vM^{-1}\gradat{n}}} \\
  &- \frac{1}{2}\angbra{\vq\ssup{n+1}, \vq\ssup{n+1}} + \frac{1}{2}\angbra{\vq\ssup{n}, \vq\ssup{n}}.
\end{align*}
Together with equation~\ref{eq:energy}, the result is
\begin{align*}
  \Delta\tilde{H} &= \Delta U -\frac{1}{2}\Delta\vtheta^\tp \bra{\nabla U\ssup{n} + \nabla U\ssup{n+1}}
                    + \frac{h^2b^2}{8}\Delta\bra{\nabla U^\tp\vM^{-1}\nabla U}.
\end{align*}

The change in effective energy does not depend on the momentum at all. Thus, we
can avoid calculating the momentum at whole time steps in
equation~\ref{eq:ovrvo-updates}, and draw only one Gaussian RV per time step.

\printbibliography
\end{document}